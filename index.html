<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dental Clinic Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e8f5e9; /* Light Green */
        }
        .form-input, .form-textarea, .form-select {
            @apply w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-800 transition duration-200;
        }
        .box-container {
            @apply p-6 rounded-lg shadow-lg border-2 border-blue-950;
        }
        .box-heading {
            @apply text-3xl font-bold text-blue-950 mb-4;
        }
        .sub-box-heading {
            @apply text-xl font-bold text-blue-950 mb-2;
        }
        .sub-box {
            @apply p-4 border border-blue-950 rounded-lg;
        }

        /* ===== STYLES FOR DISTINCT BACKGROUNDS ===== */
        .grid .box-container {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .grid .box-container:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .grid .box-container:nth-of-type(1) { background-color: #eff6ff; } /* Light Blue */
        .grid .box-container:nth-of-type(2) { background-color: #f0fdf4; } /* Light Green */
        .grid .box-container:nth-of-type(3) { background-color: #fffbeb; } /* Light Yellow/Cream */
        .grid .box-container:nth-of-type(4) { background-color: #f0fdf4; } /* Light Green */
        .grid .box-container:nth-of-type(5) { background-color: #eff6ff; } /* Light Blue */

        /* ===== STYLES FOR HIGHLIGHTED HEADINGS ===== */
        .max-w-7xl h1 {
            display: inline-block;
            background-color: #0d47a1;
            color: white;
            padding: 8px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        p[style*="#66bb6a"] {
            display: inline-block;
            background-color: #66bb6a;
            color: white !important;
            padding: 4px 12px;
            border-radius: 9999px;
            font-weight: 600;
        }
        .box-heading {
            display: inline-block;
            background-color: #1e3a8a;
            color: white;
            padding: 6px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body class="bg-green-100 p-8">

    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="modal-message"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-ok-button" class="px-4 py-2 bg-blue-800 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-900 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-green-50 rounded-xl shadow-2xl p-8 mb-12 border-2 border-blue-950">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <div>
                <h1 class="text-5xl font-extrabold text-blue-950">SMILE CARE DENTAL CLINIC</h1>
                <p class="mt-2 text-2xl font-bold" style="color:#66bb6a;">PATIENT RECORDS</p>
            </div>
            <div class="mt-4 md:mt-0 flex items-center space-x-4 text-sm text-gray-500">
                <span id="user-info"></span>
                <button id="clear-form-button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    New Entry
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-8">
            <div class="box-container relative">
                <h2 class="box-heading">PATIENT DETAILS</h2>
                <div class="absolute top-6 right-6">
                    <label for="patient-id" class="block text-sm font-medium text-gray-700">Patient ID*</label>
                    <input type="text" id="patient-id" class="form-input mt-1 bg-gray-200 cursor-not-allowed w-40" readonly>
                </div>
                <div class="mt-12 grid grid-cols-1 gap-4">
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700">Date*</label>
                        <input type="date" id="date" class="form-input mt-1">
                    </div>
                    <div>
                        <label for="time-in" class="block text-sm font-medium text-gray-700">Time In*</label>
                        <input type="time" id="time-in" class="form-input mt-1">
                    </div>
                    <div>
                        <label for="patient-name" class="block text-sm font-medium text-gray-700">Patient Name*</label>
                        <input type="text" id="patient-name" class="form-input mt-1" placeholder="Enter full name" list="patient-names">
                        <datalist id="patient-names"></datalist>
                    </div>
                    <div>
                        <label for="patient-phone" class="block text-sm font-medium text-gray-700">Phone Number*</label>
                        <input type="tel" id="patient-phone" class="form-input mt-1" placeholder="e.g., 123-456-7890">
                    </div>
                    <div>
                        <label for="patient-type" class="block text-sm font-medium text-gray-700">Case*</label>
                        <select id="patient-type" class="form-select mt-1">
                            <option value="New">New</option>
                            <option value="Old">Old</option>
                        </select>
                    </div>
                    <div>
                        <label for="age" class="block text-sm font-medium text-gray-700">Age*</label>
                        <input type="number" id="age" class="form-input mt-1" placeholder="Enter age">
                    </div>
                    <div>
                        <label for="sex" class="block text-sm font-medium text-gray-700">Gender*</label>
                        <select id="sex" class="form-select mt-1">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="appointment-type" class="block text-sm font-medium text-gray-700">Type*</label>
                        <select id="appointment-type" class="form-select mt-1">
                            <option value="Walk-in Consultation">Walk-in Consultation</option>
                            <option value="Treatment Appointment by Doctor">Treatment Appointment by Doctor</option>
                            <option value="Appointment by Call">Appointment by Call</option>
                        </select>
                    </div>
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                        <input type="text" id="address" class="form-input mt-1" placeholder="Enter or select an address" list="address-list">
                        <datalist id="address-list">
                            <option value="Pulivalam"></option>
                        </datalist>
                    </div>
                </div>
            </div>
            <div class="box-container">
                <h2 class="box-heading">TREATMENT DETAILS</h2>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="treatment-plan" class="block text-sm font-medium text-gray-700">Treatment Plan</label>
                        <input type="text" id="treatment-plan" class="form-input mt-1" placeholder="Enter or select treatment plan(s)" list="treatment-plan-list">
                        <datalist id="treatment-plan-list">
                            <option value="RCT"></option>
                        </datalist>
                    </div>
                    <div>
                        <label for="treatment-done" class="block text-sm font-medium text-gray-700">Treatment Done*</label>
                        <input type="text" id="treatment-done" class="form-input mt-1" placeholder="Enter or select treatment done" list="treatment-done-list">
                        <datalist id="treatment-done-list">
                            <option value="RCT 1"></option>
                        </datalist>
                    </div>
                    <div>
                        <label for="next-appointment" class="block text-sm font-medium text-gray-700">Next Scheduled Appointment</label>
                        <input type="datetime-local" id="next-appointment" class="form-input mt-1">
                    </div>
                </div>
            </div>
            <div class="box-container">
                <h2 class="box-heading">PATIENT CLINICAL DATA</h2>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="total-estimation" class="block text-sm font-medium text-gray-700">Treatment Estimation</label>
                        <input type="number" id="total-estimation" class="form-input mt-1" placeholder="e.g., 1200">
                    </div>
                    <div>
                        <label for="measurement-details" class="block text-sm font-medium text-gray-700">Measurement Details</label>
                        <textarea id="measurement-details" rows="2" class="form-textarea mt-1" placeholder="Enter measurement details"></textarea>
                    </div>
                    <div>
                        <label for="additional-details" class="block text-sm font-medium text-gray-700">Additional Details</label>
                        <textarea id="additional-details" rows="2" class="form-textarea mt-1" placeholder="Enter additional details"></textarea>
                    </div>
                    <div>
                        <label for="medical-history" class="block text-sm font-medium text-gray-700">Medical History</label>
                        <textarea id="medical-history" rows="2" class="form-textarea mt-1" placeholder="Enter medical history"></textarea>
                    </div>
                    <div>
                        <label for="allergy-history" class="block text-sm font-medium text-gray-700">Allergy History</label>
                        <textarea id="allergy-history" rows="2" class="form-textarea mt-1" placeholder="Enter allergy history"></textarea>
                    </div>
                    <div>
                        <label for="prescription-details" class="block text-sm font-medium text-gray-700">Prescription Details</label>
                        <textarea id="prescription-details" rows="2" class="form-textarea mt-1" placeholder="Enter prescription details"></textarea>
                    </div>
                </div>
            </div>
            <div class="box-container">
                <h2 class="box-heading">CHARGES</h2>
                <div class="grid grid-cols-1 gap-4">
                    <div class="sub-box">
                        <h3 class="sub-box-heading">Treatment Charges</h3>
                        <div>
                            <label for="total-charges" class="block text-sm font-medium text-gray-700">Total</label>
                            <input type="number" id="total-charges" class="form-input mt-1" placeholder="e.g., 500">
                        </div>
                        <div>
                            <label for="treatment-paid" class="block text-sm font-medium text-gray-700">Paid</label>
                            <input type="number" id="treatment-paid" class="form-input mt-1" placeholder="e.g., 300">
                        </div>
                        <div>
                            <label for="treatment-balance" class="block text-sm font-medium text-gray-700">Balance</label>
                            <input type="number" id="treatment-balance" class="form-input mt-1 bg-gray-200 cursor-not-allowed" readonly>
                        </div>
                    </div>
                    <div class="sub-box">
                        <h3 class="sub-box-heading">Medicine Charges</h3>
                        <div>
                            <label for="medicine-total" class="block text-sm font-medium text-gray-700">Total</label>
                            <input type="number" id="medicine-total" class="form-input mt-1" placeholder="e.g., 100">
                        </div>
                        <div>
                            <label for="medicine-paid" class="block text-sm font-medium text-gray-700">Paid</label>
                            <input type="number" id="medicine-paid" class="form-input mt-1" placeholder="e.g., 50">
                        </div>
                        <div>
                            <label for="medicine-balance" class="block text-sm font-medium text-gray-700">Balance</label>
                            <input type="number" id="medicine-balance" class="form-input mt-1 bg-gray-200 cursor-not-allowed" readonly>
                        </div>
                    </div>
                    <div>
                        <label for="gpay-time" class="block text-sm font-medium text-gray-700">Gpay Time</label>
                        <input type="text" id="gpay-time" class="form-input mt-1" placeholder="e.g., 10:30 PM">
                    </div>
                </div>
            </div>
            <div class="box-container">
                <h2 class="box-heading">PATIENT LAB RECORDS</h2>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="lab-name" class="block text-sm font-medium text-gray-700">Lab Name</label>
                        <input type="text" id="lab-name" class="form-input mt-1" placeholder="Type or select lab name" list="lab-names">
                        <datalist id="lab-names">
                            <option value="Arthi Lab"></option>
                        </datalist>
                    </div>
                    <div>
                        <label for="lab-details" class="block text-sm font-medium text-gray-700">Details</label>
                        <textarea id="lab-details" rows="2" class="form-textarea mt-1" placeholder="Enter details"></textarea>
                    </div>
                    <div>
                        <label for="shade" class="block text-sm font-medium text-gray-700">Shade</label>
                        <input type="text" id="shade" class="form-input mt-1" placeholder="e.g., A2">
                    </div>
                    <div>
                        <label for="work-type" class="block text-sm font-medium text-gray-700">Work Type</label>
                        <input type="text" id="work-type" class="form-input mt-1" placeholder="e.g., Crown, Bridge">
                    </div>
                    <div>
                        <label for="trays-given" class="block text-sm font-medium text-gray-700">Trays Given</label>
                        <select id="trays-given" class="form-select mt-1">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div>
                        <label for="out-date" class="block text-sm font-medium text-gray-700">Out Date</label>
                        <input type="date" id="out-date" class="form-input mt-1">
                    </div>
                    <div>
                        <label for="in-date" class="block text-sm font-medium text-gray-700">In Date</label>
                        <input type="date" id="in-date" class="form-input mt-1">
                    </div>
                </div>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mb-12">
            <button id="save-button" class="bg-blue-800 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-900 transition duration-300 transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2l4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Save Patient Data
            </button>
            <button id="export-button" class="bg-blue-800 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-900 transition duration-300 transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Export to Excel (CSV)
            </button>
        </div>

        <div id="patient-list-container" class="mt-8 bg-white p-6 rounded-xl shadow-2xl border-2 border-blue-950">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Patient Records</h2>
            <div id="loading-spinner" class="text-center text-gray-500 hidden">
                <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2">Loading patient data...</p>
            </div>
            <div class="overflow-x-auto shadow-md rounded-lg">
                <table id="patient-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Treatment</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Charges</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="patient-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCwGa9Wt1SsnXXGTInfmvrIB7-oRiwvKJw",
          authDomain: "smilecare-dental-15cb6.firebaseapp.com",
          projectId: "smilecare-dental-15cb6",
          storageBucket: "smilecare-dental-15cb6.firebasestorage.app",
          messagingSenderId: "167225564766",
          appId: "1:167225564766:web:a5a1ea64c8333e33145ecf",
          measurementId: "G-3RGE45PHGF"
        };

        const appId = firebaseConfig.projectId;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let userId;
        let isAuthReady = false;

        function showModal(title, message) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
        }
        document.getElementById('modal-ok-button').addEventListener('click', hideModal);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
            } else {
                try {
                    await signInAnonymously(auth);
                    userId = auth.currentUser.uid;
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    showModal('Authentication Error', 'An error occurred during authentication. Check console.');
                    userId = crypto.randomUUID(); 
                }
            }
            document.getElementById('user-info').innerText = `User ID: ${userId}`;
            isAuthReady = true;
            setupFirestoreListener();
            await setupAutocompleteListeners();
            formElements.patientId.value = generatePatientId();
        });

        const formElements = {
            patientId: document.getElementById('patient-id'),
            date: document.getElementById('date'),
            timeIn: document.getElementById('time-in'),
            patientName: document.getElementById('patient-name'),
            patientPhone: document.getElementById('patient-phone'),
            patientType: document.getElementById('patient-type'),
            age: document.getElementById('age'),
            sex: document.getElementById('sex'),
            appointmentType: document.getElementById('appointment-type'),
            address: document.getElementById('address'),
            treatmentPlan: document.getElementById('treatment-plan'),
            treatmentDone: document.getElementById('treatment-done'),
            nextAppointment: document.getElementById('next-appointment'),
            totalCharges: document.getElementById('total-charges'),
            treatmentPaid: document.getElementById('treatment-paid'),
            treatmentBalance: document.getElementById('treatment-balance'),
            medicineTotal: document.getElementById('medicine-total'),
            medicinePaid: document.getElementById('medicine-paid'),
            medicineBalance: document.getElementById('medicine-balance'),
            gpayTime: document.getElementById('gpay-time'),
            totalEstimation: document.getElementById('total-estimation'),
            measurementDetails: document.getElementById('measurement-details'),
            additionalDetails: document.getElementById('additional-details'),
            medicalHistory: document.getElementById('medical-history'),
            allergyHistory: document.getElementById('allergy-history'),
            prescriptionDetails: document.getElementById('prescription-details'),
            labName: document.getElementById('lab-name'),
            labDetails: document.getElementById('lab-details'),
            shade: document.getElementById('shade'),
            workType: document.getElementById('work-type'),
            traysGiven: document.getElementById('trays-given'),
            outDate: document.getElementById('out-date'),
            inDate: document.getElementById('in-date')
        };
        
        function generatePatientId(name = '', age = '', sex = '') {
            const cleanName = name.replace(/\s/g, '').toLowerCase();
            const hash = cleanName.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) + (age || '') + (sex ? sex.charCodeAt(0) : '');
            const timestamp = new Date().getTime();
            return `SCDC-${timestamp}-${hash}`;
        }

        const patientCache = {};
        
        async function fetchAllPatients() {
            if (!isAuthReady) return;
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'patients');
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach(doc => {
                const patient = doc.data();
                patientCache[patient.id] = patient;
            });
        }
        
        async function setupAutocompleteListeners() {
            await fetchAllPatients();
            
            const patientNamesList = document.getElementById('patient-names');
            const uniqueNames = [...new Set(Object.values(patientCache).map(p => p.patientName))];
            patientNamesList.innerHTML = uniqueNames.map(name => `<option value="${name}"></option>`).join('');

            formElements.patientName.addEventListener('change', (e) => {
                const selectedName = e.target.value;
                const patient = Object.values(patientCache).find(p => p.patientName === selectedName);
                if (patient) {
                    fillFormWithPatientData(patient);
                }
            });

            formElements.patientPhone.addEventListener('blur', (e) => {
                const phoneNumber = e.target.value;
                const patient = Object.values(patientCache).find(p => p.patientPhone === phoneNumber);
                if (patient) {
                    fillFormWithPatientData(patient);
                }
            });
        }

        function fillFormWithPatientData(patient) {
            formElements.patientType.value = 'Old';
            for (const key in formElements) {
                if (patient[key] !== undefined) {
                    formElements[key].value = patient[key];
                }
            }
            calculateBalances();
        }

        function calculateBalances() {
            const totalCharges = parseFloat(formElements.totalCharges.value) || 0;
            const treatmentPaid = parseFloat(formElements.treatmentPaid.value) || 0;
            const medicineTotal = parseFloat(formElements.medicineTotal.value) || 0;
            const medicinePaid = parseFloat(formElements.medicinePaid.value) || 0;
            formElements.treatmentBalance.value = (totalCharges - treatmentPaid).toFixed(2);
            formElements.medicineBalance.value = (medicineTotal - medicinePaid).toFixed(2);
        }

        ['totalCharges', 'treatmentPaid', 'medicineTotal', 'medicinePaid'].forEach(id => {
            document.getElementById(id).addEventListener('input', calculateBalances);
        });
        
        document.getElementById('save-button').addEventListener('click', async (). => {
            const requiredFields = ['date', 'timeIn', 'patientName', 'patientPhone', 'patientType', 'age', 'sex', 'appointmentType', 'treatmentDone'];
            const missingFields = requiredFields.filter(field => !formElements[field].value);
            
            if (missingFields.length > 0) {
                showModal('Validation Error', `Please fill out all required fields: ${missingFields.join(', ')}`);
                return;
            }
            
            const patientId = formElements.patientId.value;
            const data = {
                id: patientId,
                timestamp: new Date().toISOString(),
            };

            for (const key in formElements) {
                data[key] = formElements[key].value;
            }

            try {
                const patientDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'patients', patientId);
                await setDoc(patientDocRef, data, { merge: true });
                showModal('Success!', 'Patient data saved successfully.');
                clearForm();
            } catch (error) {
                console.error("Error saving document:", error);
                showModal('Error', 'Failed to save data. Please try again.');
            }
        });

        function clearForm() {
            Object.values(formElements).forEach(element => {
                if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                    if(element.id !== 'patient-id') element.value = '';
                } else if (element.tagName === 'SELECT') {
                    element.selectedIndex = 0;
                }
            });
            formElements.patientId.value = generatePatientId();
        }

        document.getElementById('clear-form-button').addEventListener('click', clearForm);

        document.getElementById('export-button').addEventListener('click', async () => {
            const patientData = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'patients'));
            const patients = patientData.docs.map(doc => doc.data());
            
            if (patients.length === 0) {
                showModal('No Data', 'There is no patient data to export.');
                return;
            }
            
            const header = Object.keys(patients[0]);
            let csvContent = header.join(',') + '\n';
            
            patients.forEach(patient => {
                const row = header.map(fieldName => {
                    const value = patient[fieldName] || '';
                    const stringValue = String(value).replace(/"/g, '""');
                    return `"${stringValue}"`;
                });
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'dental_patient_data.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        async function deletePatient(docId) {
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'patients', docId));
                showModal('Deleted', 'Patient record deleted successfully.');
            } catch (error) {
                console.error("Error removing document: ", error);
                showModal('Error', 'Failed to delete record.');
            }
        }

        function setupFirestoreListener() {
            if (!isAuthReady || !db) return;

            const q = collection(db, 'artifacts', appId, 'public', 'data', 'patients');
            const patientTableBody = document.getElementById('patient-table-body');
            const loadingSpinner = document.getElementById('loading-spinner');
            loadingSpinner.classList.remove('hidden');

            onSnapshot(q, (querySnapshot) => {
                loadingSpinner.classList.add('hidden');
                patientTableBody.innerHTML = '';
                const allPatients = [];
                querySnapshot.forEach((doc) => allPatients.push(doc.data()));
                
                allPatients.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

                allPatients.forEach((patient) => {
                    patientCache[patient.id] = patient;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${patient.date || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${patient.id || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${patient.patientName || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${patient.patientPhone || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${patient.treatmentDone || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">₹${patient.totalCharges || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-500">₹${patient.treatmentBalance || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-indigo-600 hover:text-indigo-900 mr-3 edit-button">Edit</button>
                            <button class="text-red-600 hover:text-red-900 delete-button">Delete</button>
                        </td>
                    `;
                    row.querySelector('.delete-button').addEventListener('click', () => deletePatient(patient.id));
                    row.querySelector('.edit-button').addEventListener('click', () => fillFormWithPatientData(patient));
                    patientTableBody.appendChild(row);
                });
            }, (error) => {
                console.error("Error listening to Firestore updates:", error);
                loadingSpinner.classList.add('hidden');
                showModal('Error', 'Could not fetch patient records.');
            });
        }
    </script>
</body>
</html>
